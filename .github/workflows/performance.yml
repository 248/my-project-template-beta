name: Performance Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯Žæ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'

jobs:
  performance-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        backend-mode: [monolith, service]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.0.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate API types and client
        run: pnpm generate

      - name: Build packages
        run: pnpm build:packages

      - name: Setup test environment variables
        run: |
          cp .dev.vars.example .dev.vars
          echo "BACKEND_MODE=${{ matrix.backend-mode }}" >> .dev.vars

      - name: Start development server
        run: |
          pnpm dev &
          echo $! > dev-server.pid

          # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’å¾…æ©Ÿ
          timeout=30
          while [ $timeout -gt 0 ]; do
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "Development server is ready"
              break
            fi
            sleep 1
            timeout=$((timeout - 1))
          done

          if [ $timeout -eq 0 ]; then
            echo "Development server failed to start"
            exit 1
          fi

      - name: Run performance tests
        id: perf-test
        run: |
          pnpm test:perf:ci
        env:
          BACKEND_MODE: ${{ matrix.backend-mode }}

      - name: Stop development server
        if: always()
        run: |
          if [ -f dev-server.pid ]; then
            kill $(cat dev-server.pid) || true
            rm dev-server.pid
          fi

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results-${{ matrix.backend-mode }}
          path: |
            performance-results.json
          retention-days: 30

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹çµæžœã‚’èª­ã¿è¾¼ã¿ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            let perfResults = null;
            try {
              if (fs.existsSync('performance-results.json')) {
                perfResults = JSON.parse(fs.readFileSync('performance-results.json', 'utf8'));
              }
            } catch (error) {
              console.log('Performance results not found or invalid');
            }

            const backendMode = '${{ matrix.backend-mode }}';
            const passed = '${{ steps.perf-test.outcome }}' === 'success';

            let comment = `## ðŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæžœ (${backendMode}ãƒ¢ãƒ¼ãƒ‰)\n\n`;

            if (perfResults) {
              const { results, target, passed: testPassed } = perfResults;
              const status = testPassed ? 'âœ… PASS' : 'âŒ FAIL';
              
              comment += `**çµæžœ**: ${status}\n\n`;
              comment += `| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å€¤ | ç›®æ¨™ |\n`;
              comment += `|-----------|----|----- |\n`;
              comment += `| p95ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ | ${results.p95}ms | â‰¤ ${target}ms |\n`;
              comment += `| å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ | ${results.avgLatency}ms | - |\n`;
              comment += `| ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ | ${results.throughput} req/sec | - |\n`;
              comment += `| ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•° | ${results.totalRequests.toLocaleString()} | - |\n`;
              comment += `| ã‚¨ãƒ©ãƒ¼æ•° | ${results.errors} | - |\n\n`;
              
              if (!testPassed) {
                comment += `âš ï¸ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›®æ¨™æœªé”æˆ**\n`;
                comment += `p95ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãŒç›®æ¨™å€¤(${target}ms)ã‚’è¶…éŽã—ã¦ã„ã¾ã™ã€‚\n\n`;
                comment += `**æ”¹å–„ææ¡ˆ**:\n`;
                comment += `- SupabaseæŽ¥ç¶šãƒ—ãƒ¼ãƒ«ã®æœ€é©åŒ–\n`;
                comment += `- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å®Ÿè£…\n`;
                comment += `- ä¸è¦ãªãƒ­ã‚°å‡ºåŠ›ã®å‰Šæ¸›\n`;
                comment += `- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–\n`;
              }
            } else {
              comment += `**çµæžœ**: ${passed ? 'âœ… PASS' : 'âŒ FAIL'}\n\n`;
              if (!passed) {
                comment += `ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n`;
              }
            }

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes(`ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæžœ (${backendMode}ãƒ¢ãƒ¼ãƒ‰)`)
            );

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  performance-summary:
    runs-on: ubuntu-latest
    needs: performance-test
    if: always()

    steps:
      - name: Download performance results
        uses: actions/download-artifact@v4
        with:
          pattern: performance-results-*
          merge-multiple: true

      - name: Generate performance summary
        run: |
          echo "# ðŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for mode in monolith service; do
            if [ -f "performance-results-${mode}.json" ]; then
              echo "## ${mode}ãƒ¢ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
              
              # JSONã‹ã‚‰çµæžœã‚’æŠ½å‡ºï¼ˆjqãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
              if command -v jq >/dev/null 2>&1; then
                p95=$(jq -r '.results.p95' "performance-results-${mode}.json")
                target=$(jq -r '.target' "performance-results-${mode}.json")
                passed=$(jq -r '.passed' "performance-results-${mode}.json")
                
                if [ "$passed" = "true" ]; then
                  echo "âœ… **PASS** - p95: ${p95}ms (ç›®æ¨™: â‰¤${target}ms)" >> $GITHUB_STEP_SUMMARY
                else
                  echo "âŒ **FAIL** - p95: ${p95}ms (ç›®æ¨™: â‰¤${target}ms)" >> $GITHUB_STEP_SUMMARY
                fi
              else
                echo "çµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "## ${mode}ãƒ¢ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
              echo "âŒ ãƒ†ã‚¹ãƒˆçµæžœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
